# Twilight Relayer Core

## Introduction

Twilight Relayer Core is an extremely high performance matching engine written in Rust.

Relayer uses Event Sourcing pattern with CQRS framework to handle tens of thousands of orders per second or even better, depending on the performance of persistence. Basic architecture is shown below.

```
                          +----------+
Client Request Queue  >>  |  Relayer |  >> Event Logs
                          +----------+
```

## Getting Started

### Dependencies

- Kafka/Zookeeper: to make client request queue and persist the events logs
- PostgreSQL: persist the events and output the match result
- nginx/envoy: for proxy and loadbalancing
- Redis: for fast read and auth management

### Quick Start

First start kafka and zookeeper and create topic on kafka for messege queuing and storing event logs.
Run the below commands:

```yaml
docker-compose up --build kafka zookeeper
```

when the zookeeper and the kafka start running properly then create topic using below command on terminal:

```yaml
docker exec -it zookeeper sh -c "cd usr/bin && kafka-topics --topic CLIENT-REQUEST --create --zookeeper zookeeper:2181 --partitions 1 --replication-factor 1 --config retention.ms=-1 --config cleanup.policy=compact --config message.timestamp.type=LogAppendTime" && \
docker exec -it zookeeper sh -c "cd usr/bin && kafka-topics --topic SnapShotLogTopic --create --zookeeper zookeeper:2181 --partitions 1 --replication-factor 1 --config retention.ms=-1 --config cleanup.policy=compact --config message.timestamp.type=LogAppendTime" && \
docker exec -it zookeeper sh -c "cd usr/bin && kafka-topics --topic CoreEventLogTopic --create --zookeeper zookeeper:2181 --partitions 1 --replication-factor 1 --config retention.ms=-1 --config cleanup.policy=compact --config message.timestamp.type=LogAppendTime" && \
docker exec -it zookeeper sh -c "cd usr/bin && kafka-topics --topic RelayerStateQueue --create --zookeeper zookeeper:2181 --partitions 1 --replication-factor 1 --config retention.ms=-1 --config cleanup.policy=compact --config message.timestamp.type=LogAppendTime" && \
docker exec -it zookeeper sh -c "cd usr/bin && kafka-topics --topic CLIENT-FAILED-REQUEST --create --zookeeper zookeeper:2181 --partitions 1 --replication-factor 1 --config retention.ms=-1 --config cleanup.policy=compact --config message.timestamp.type=LogAppendTime"
```

Note: we are using topic "CLIENT-REQUEST" for client order request and "CoreEventLogTopic" to store event logs generated by relayer.

After successfully creating topics on kafka. Run the following command to run relayer app

```yaml
docker-compose up --build
```

### Create/Settle Order

refer POSTMAN requests : [Click Here](./Postman%20Requests/Postman%20Requests.postman_collection.json)

To allow https request run

```yaml
docker compose run --rm  certbot certonly --webroot --webroot-path /var/www/certbot/ -d example.org
```

Note: first try dry run for certificate

```yaml
docker compose run --rm  certbot certonly --webroot --webroot-path /var/www/certbot/ --dry-run -d example.org
```

Reference url : [https://mindsers.blog/post/https-using-nginx-certbot-docker/](https://mindsers.blog/post/https-using-nginx-certbot-docker/)

### Running Relayer with Supervisor

#### 1. Install Supervisor

To manage the relayer application, we will use Supervisor, a process control system. Follow these steps to install and configure Supervisor:

1. **Update Package Lists:**

   Begin by updating your package lists to ensure you have the latest information on the newest versions of packages and their dependencies.

   ```bash
   sudo apt update
   ```

2. **Install Supervisor:**

   Install Supervisor using the following command:

   ```bash
   sudo apt install supervisor
   ```

3. **Configure Supervisor for Relayer:**

   Create a configuration file for the relayer application. This file will tell Supervisor how to manage the relayer process.

```bash
mkdir -p /home/ubuntu/Relayer-dev/relayer-core/logs


sudo tee /etc/supervisor/conf.d/relayer.conf > /dev/null <<EOF
[program:relayer]
command=/home/ubuntu/Relayer-dev/relayer-core/target/release/main
directory=/home/ubuntu/Relayer-dev/relayer-core
autostart=true
autorestart=true
stderr_logfile=/home/ubuntu/Relayer-dev/relayer-core/logs/relayer.err.log
stdout_logfile=/home/ubuntu/Relayer-dev/relayer-core/logs/relayer.out.log
user=ubuntu
environment=HOME="/home/ubuntu"
stderr_logfile_maxbytes=50MB
stdout_logfile_maxbytes=50MB
stderr_logfile_backups=10
stdout_logfile_backups=10
EOF

```

4. **Update Supervisor:**

After creating the configuration file, update Supervisor to recognize the new configuration.

```bash
sudo supervisorctl reread
sudo supervisorctl update
```

5. **Start the Relayer Program:**

   Finally, start the relayer program using Supervisor.

   ```bash
   sudo supervisorctl start relayer
   ```

By following these steps, Supervisor will automatically manage the relayer application, ensuring it starts at boot and restarts if it crashes.
